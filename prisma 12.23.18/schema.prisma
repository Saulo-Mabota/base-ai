// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id       String  @id @default(auto()) @map("_id") @db.ObjectId
  email    String  @unique
  username String  @unique
  password String?
  picture  String?
  role     Role    @relation(fields: [roleId], references: [id])
  roleId   String  @db.ObjectId

  entityId String
  entity   Entity @relation(fields: [entityId], references: [id], name: "EntityUsers")

  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id], name: "customerUser")

  createdAt DateTime? @default(now())
  updatedAt DateTime? @default(now())
  Order     Order[]   @relation(name: "UserOrder")
  payment   Payment[] @relation(name: "paymentUser")
  Stock     Stock[]   @relation(name: "UserStock")

  @@map("users")
}

// Definição do modelo de função (role)
model Role {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?

  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id], name: "DepartmentRole")

  permissions Permission[] @relation("RolePermissions")
  Users       User[]
  createdAt   DateTime?    @default(now())
  updatedAt   DateTime?    @default(now())

  @@map("roles")
}

// Definição do modelo de permissão
model Permission {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String
  isMenu      Boolean @default(false)
  position    Int?

  roleId String
  role   Role              @relation(fields: [roleId], references: [id], name: "RolePermissions")
  label  LabelPermission[] @relation(name: "PermissionsLabelPermissions")

  createdAt DateTime? @default(now())
  updatedAt DateTime? @default(now())

  @@map("permissions")
}

model Entity {
  id          String       @id @default(auto()) @map("_id") @db.ObjectId
  name        String       @unique
  description String
  departments Department[] @relation("EntityDepartments")
  users       User[]       @relation("EntityUsers")
  categoreis  Category[]   @relation(name: "EntityCategory")
  coupons     Coupon[]     @relation(name: "EntityCoupon")
  orders      Order[]      @relation(name: "EntityOrder")
  payment     Payment[]    @relation(name: "EntityPayment")
  Product     Product[]    @relation(name: "EntityProduct")

  createdAt   DateTime?     @default(now())
  updatedAt   DateTime?     @default(now())
  Table       Table[]       @relation(name: "EntityPayment")
  SubCategory SubCategory[] @relation(name: "EntitySubCategory")
  Customer    Customer[]    @relation(name: "EntityCustomer")

  @@map("entities")
}

model Department {
  id          String @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String

  entityId String
  entity   Entity @relation(fields: [entityId], references: [id], name: "EntityDepartments")

  role     Role[]     @relation(name: "DepartmentRole")
  Category Category[] @relation(name: "DepartmentCategory")

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())
  Stock     Stock[]  @relation(name: "department_has_stock")
  Order     Order[]  @relation(name: "DepartmentOrder")

  @@map("departments")
}

model Category {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  type        String?

  entityId String
  entity   Entity @relation(fields: [entityId], references: [id], name: "EntityCategory")

  departmentId  String?
  department    Department?   @relation(fields: [departmentId], references: [id], name: "DepartmentCategory")
  stock         Stock[]       @relation(name: "CategoryStock")
  subCategories SubCategory[] @relation("CategorySubCategory")

  createdAt DateTime? @default(now())
  updatedAt DateTime? @default(now())

  @@map("categories")
}

model SubCategory {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  products    Product[] @relation("SubCategoryProducts")

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], name: "CategorySubCategory")

  entityId String
  entity   Entity @relation(fields: [entityId], references: [id], name: "EntitySubCategory")

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  @@map("subcategories")
}

model Product {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String
  cover       String?
  price       Float?
  quantity    Int?
  entityId    String
  entity      Entity  @relation(fields: [entityId], references: [id], name: "EntityProduct")

  subCategoryId String?
  subCategory   SubCategory?      @relation(fields: [subCategoryId], references: [id], name: "SubCategoryProducts")
  orderItem     OrderItem[]       @relation(name: "orderItem_has_product")
  ingredients   StockHasProduct[] @relation(name: "product_has_stock")

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  @@map("products")
}

model Stock {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  stockId String?
  stock   Stock?  @relation(fields: [stockId], references: [id], name: "stock_has_stock", onDelete: NoAction, onUpdate: NoAction)

  isAvailable Boolean @default(false)

  departmentId String     @db.ObjectId
  department   Department @relation(fields: [departmentId], references: [id], name: "department_has_stock")

  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id], name: "CategoryStock")

  userId String?
  user   User?   @relation(fields: [userId], references: [id], name: "UserStock")

  product StockHasProduct[] @relation(name: "stock_has_product")
  request Stock[]           @relation(name: "stock_has_stock")

  name         String
  description  String?
  unity_type   String?
  action       String?
  unit_price   Float?
  quantity     Float?
  min_quantity Float?
  brand        String?

  isActive Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  @@map("stocks")
}

model StockHasProduct {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  stockId String
  stock   Stock  @relation(fields: [stockId], references: [id], name: "stock_has_product")

  productId String
  product   Product @relation(fields: [productId], references: [id], name: "product_has_stock")

  unity_type String?
  quantity   Float

  createdAt DateTime @default(now()) @map("createdAt")
  updatedAt DateTime @updatedAt @map("updatedAt") // Usa @updatedAt para atualização automática

  @@map("stockhasproducts")
}

// model RequestStock {
//   id String @id @default(auto()) @map("_id") @db.ObjectId
//  stockId String
//   stock   Stock  @relation(fields: [stockId], references: [id], name: "stock_has_product")
//  departmentId String            @db.ObjectId
//   department   Department        @relation(fields: [departmentId], references: [id], name: "department_has_stock")

//   unity_type  String?
//   unit_price  Float?
//   quantity    Int
//   isActive    Boolean @default(false)

//   createdAt DateTime @default(now())
//   updatedAt DateTime @default(now())
//   @@map("requeststock")
// }

model Address {
  id        String     @id @default(auto()) @map("_id") @db.ObjectId
  pincode   String?
  address   String?
  city      String?
  state     String?
  country   String?
  landmark  String?
  lat       String?
  long      String?
  save_as   String     @default("Home")
  customers Customer[] @relation(name: "AddressCustomer")

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  @@map("addresses")
}

model Customer {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  id_number String?
  firstName String
  lastName  String
  gender    String
  born_date String?

  phone_number     String
  phone_alt_number String?
  type             String?
  nuit             String?
  website          String?
  location         String?
  email            String?
  addressId        String?
  address          Address? @relation(fields: [addressId], references: [id], name: "AddressCustomer")

  entityId String
  entity   Entity @relation(fields: [entityId], references: [id], name: "EntityCustomer")

  orders Order[] @relation(name: "OrderCustomer")
  User   User[]  @relation(name: "customerUser")

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  @@map("customers")
}

model Coupon {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  code               String
  isPercentage       Boolean
  description        String?
  isActive           Boolean
  expiryDate         String
  discount           Int       @default(0)
  minimumOrderAmount Float     @default(0)
  payments           Payment[] @relation(name: "paymentCoupon")
  entityId           String
  entity             Entity    @relation(fields: [entityId], references: [id], name: "EntityCoupon")

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  @@map("coupons")
}

model Order {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], name: "OrderCustomer")
  entityId   String
  entity     Entity   @relation(fields: [entityId], references: [id], name: "EntityOrder")

  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id], name: "DepartmentOrder")

  userId String
  user   User   @relation(fields: [userId], references: [id], name: "UserOrder")

  ref            String
  typeOrder      String //dine in
  status         String // pending
  isPayed        Boolean
  total_price    Float
  payment        Payment[]        @relation(name: "paymentOrderItem")
  orderItems     OrderItem[]      @relation(name: "orderOrderItem")
  TablesHasOrder TablesHasOrder[] @relation(name: "orderTables")

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  @@map("orders")
}

model OrderItem {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  orderId String
  order   Order  @relation(fields: [orderId], references: [id], name: "orderOrderItem")

  productId String?
  product   Product? @relation(fields: [productId], references: [id], name: "orderItem_has_product")

  unity_type  String?
  quantity    Int
  description String?
  unit_price  Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  @@map("orderitems")
}

model Payment {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  orderId  String
  order    Order   @relation(fields: [orderId], references: [id], name: "paymentOrderItem")
  couponId String?
  coupon   Coupon? @relation(fields: [couponId], references: [id], name: "paymentCoupon")

  entityId String
  entity   Entity @relation(fields: [entityId], references: [id], name: "EntityPayment")

  userId String?
  user   User?   @relation(fields: [userId], references: [id], name: "paymentUser")

  total_payed        Float
  exchange           Float
  payment_mode       String
  transactionRespAPI String?
  transaction_id     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  @@map("payments")
}

model LabelPermission {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  lang        String   @default("pt")
  title       String   @default("MenuItem")
  icon        String?
  link        String?
  isHeadr     Boolean?
  position    Int?
  description String   @default("Menu description")

  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], name: "PermissionsLabelPermissions")

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  @@map("labelpermissions")
}

model Table {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  customers   Int

  entityId String
  entity   Entity @relation(fields: [entityId], references: [id], name: "EntityPayment")

  TablesHasOrder TablesHasOrder[] @relation(name: "TablesOrdes")

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  @@map("tables")
}

model TablesHasOrder {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  orderId String
  order   Order  @relation(fields: [orderId], references: [id], name: "orderTables")

  tableId String
  table   Table  @relation(fields: [tableId], references: [id], name: "TablesOrdes")

  guess Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  @@map("tableshasorder")
}
